<!doctype html>
<html>
<head>
  <meta charset="utf8">
  <style>
    * {
      box-sizing: border-box;
    }
    body, #root, svg, canvas {
      margin: 0;
      padding: 0;
      outline: none;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.133.1/build/three.min.js"></script>
  <script>
    const OBJ_FILE = 'car.obj'
    const MAX_POINTS = 659444 // `grep "v " car.obj | wc -l`

    const width = window.innerWidth
    const height = window.innerHeight

    const scene = new THREE.Scene()
    const camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 500)

    const renderer = new THREE.WebGLRenderer()
    renderer.setSize(width, height)
    document.getElementById('root').appendChild(renderer.domElement)

    camera.position.z = 120

    // Create particles
    const geometry = new THREE.BufferGeometry()
    const positions = new Float32Array(MAX_POINTS * 3)
    let lastIndex = 0

    geometry.setAttribute('position', new THREE.BufferAttribute(new Float32Array(positions), 3))

    geometry.setDrawRange(0, 0)

    const material = new THREE.PointsMaterial({
      color: 0xffffff,
      size: 0.1,
      transparent: true,
      opacity: 0.5
    })
    const points = new THREE.Points(geometry, material)
    scene.add(points)

    points.position.y = -20
    points.scale.set(40, 40, 40)

    function addVertex (x, y, z) {
      const positions = points.geometry.attributes.position.array
      positions[lastIndex++] = x
      positions[lastIndex++] = y
      positions[lastIndex++] = z

      // Performance: batch these
      points.geometry.setDrawRange(0, lastIndex / 3)
      points.geometry.attributes.position.needsUpdate = true
    }

    function render () {
      requestAnimationFrame(render)
      points.rotation.y += 0.01
      renderer.render(scene, camera)
    }

    const worker = new Worker('worker.js')
    worker.addEventListener('message', e => addVertex(...e.data))
    worker.postMessage(OBJ_FILE)

    render()
  </script>
</body>
</html>
